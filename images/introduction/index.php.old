<?php 

date_default_timezone_set('Asia/Tokyo');

require $_SERVER['DOCUMENT_ROOT'] . '/modules/Response.class.php';
$response = new Response();

// 更新時刻
$mod_time = 0;

// ディレクトリ内を検索し、エントリーリストと最終更新時刻を取得する
$directory = dir(dirname(__FILE__));
$items = array();
$ext_re = '/\.(png|jpg|jpeg)$/i';

while(($entry = $directory->read()) !== false) {
	$mod = filemtime("{$directory->path}/$entry");
	if($mod_time < $mod)
		$mod_time = $mod;
	if(preg_match($ext_re, $entry) === 1) $items[] = $entry;
}

if($mod_time !== 0) {
	header('Last-Modified' . gmdate('D, d M Y H:i:s', $mod_time) . ' GMT');
	// if-modified-sinceの解釈。304を返す場合をフォロー。
	if(isset($_SERVER['HTTP_IF_MODIFIED_SINCE'])) {
		$mod_since = preg_replace( '/;.*/', '', $_SERVER['HTTP_IF_MODIFIED_SINCE']);
		if(!preg_match("/GMT/", $mod_since)) $mod_since .= ' GMT';
		$mod_since = strtotime($mod_since);
		if($mod_time <= $mod_since) {
			$response->writeHead(304);
			$response->end();
			exit;
		}
	}
}

$items = array(
	'lastModified' => date('c', $mod_time),
	'files' => $items,
	'dirname' => $_SERVER['REQUEST_URI']
);

$response->setHeader('Content-Type', 'application/json; charset=utf-8');

if(isset($_SERVER['HTTP_ACCEPT']) && preg_match('{(?:application/json|text/plain)}', $_SERVER['HTTP_ACCEPT']) === 1) {
	$response->writeHead(200);
} else {
	$response->writeHead(406);
}

$response->end(json_encode($items));

?>